name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    
    services:
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: 3.2
        bundler-cache: true

    - name: Set up test environment
      run: |
        cp .env.example .env
        echo "TMDB_API_KEY=test_key_for_ci" >> .env
        echo "REDIS_URL=redis://localhost:6379" >> .env
        echo "RACK_ENV=test" >> .env

    - name: Run database setup (if needed)
      run: |
        # Add any database setup commands here if you add a DB later
        echo "No database setup required"

    - name: Run RSpec tests
      run: bundle exec rspec --format progress --format RspecJunitFormatter --out tmp/rspec_results.xml

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: rspec-results
        path: tmp/rspec_results.xml

    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report
        path: coverage/

  security:
    name: Security Audit
    runs-on: ubuntu-latest
    needs: test

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: 3.2
        bundler-cache: true

    - name: Run bundle audit
      run: |
        gem install bundle-audit
        bundle audit --update

    - name: Run brakeman security scanner
      run: |
        gem install brakeman
        brakeman --no-pager --format json --output tmp/brakeman_results.json || true

    - name: Upload security scan results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-results
        path: tmp/brakeman_results.json

  lint:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: 3.2
        bundler-cache: true

    - name: Run RuboCop
      run: bundle exec rubocop --format github

    - name: Check for TODO/FIXME comments
      run: |
        if grep -r "TODO\|FIXME" --include="*.rb" --include="*.erb" . ; then
          echo "::warning::Found TODO/FIXME comments in code"
        fi

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [test, security, lint]
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment: staging

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to Render (Staging)
      run: |
        curl -X POST "${{ secrets.RENDER_STAGING_DEPLOY_HOOK }}" \
             -H "Content-Type: application/json" \
             -d '{"clear_cache": false}'

    - name: Wait for deployment
      run: sleep 60

    - name: Health check staging
      run: |
        curl -f "${{ secrets.STAGING_URL }}/health/simple" || exit 1

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [test, security, lint]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create GitHub release
      if: contains(github.event.head_commit.message, 'Release:')
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ github.run_number }}
        release_name: Release v${{ github.run_number }}
        body: |
          Automated release from commit ${{ github.sha }}
          
          Changes:
          ${{ github.event.head_commit.message }}
        draft: false
        prerelease: false

    - name: Deploy to Render (Production)
      run: |
        curl -X POST "${{ secrets.RENDER_PRODUCTION_DEPLOY_HOOK }}" \
             -H "Content-Type: application/json" \
             -d '{"clear_cache": true}'

    - name: Wait for deployment
      run: sleep 90

    - name: Health check production
      run: |
        curl -f "${{ secrets.PRODUCTION_URL }}/health/simple" || exit 1

    - name: Notify deployment success
      if: success()
      run: |
        echo "âœ… Production deployment successful!"
        echo "ðŸš€ Application available at: ${{ secrets.PRODUCTION_URL }}"

    - name: Notify deployment failure
      if: failure()
      run: |
        echo "âŒ Production deployment failed!"
        exit 1

  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [test, security, lint, deploy-production]
    if: always()

    steps:
    - name: Notification Summary
      run: |
        echo "## CI/CD Pipeline Results" >> $GITHUB_STEP_SUMMARY
        echo "- **Tests**: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Security**: ${{ needs.security.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Lint**: ${{ needs.lint.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Deploy**: ${{ needs.deploy-production.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Author**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY