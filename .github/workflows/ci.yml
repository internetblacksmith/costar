name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  RUBY_VERSION: 3.4.2
  REDIS_URL: redis://localhost:6379
  RACK_ENV: test
  TMDB_API_KEY: test_api_key_for_vcr # VCR cassettes don't need real API key
  
jobs:
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ env.RUBY_VERSION }}
        bundler-cache: true
    
    - name: Install Chrome for Cuprite
      uses: browser-actions/setup-chrome@v1
      with:
        chrome-version: stable
    
    - name: Run Unit Tests
      run: bundle exec rspec spec/lib --format documentation
    
    - name: Run Integration Tests
      run: bundle exec rspec spec/requests --format documentation
    
    - name: Run Accessibility Tests
      run: ACCESSIBILITY_TESTS=true bundle exec rspec spec/accessibility --format documentation
      continue-on-error: true # Don't fail PR if accessibility tests fail
    
    - name: Run Performance Tests
      run: bundle exec rspec spec/performance --format documentation
      continue-on-error: true
    
    - name: Run Security Tests
      run: bundle exec rspec spec/security --format documentation
    
    - name: Run E2E Tests (Cucumber)
      run: bundle exec cucumber --format progress
    
    - name: Upload Test Coverage
      uses: actions/upload-artifact@v5
      if: always()
      with:
        name: coverage
        path: coverage/
    
    - name: Comment Test Results
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request'
      with:
        script: |
          const { execSync } = require('child_process');
          const coverage = execSync('cat coverage/.last_run.json 2>/dev/null || echo "{}"').toString();
          
          let coverageData = {};
          try {
            coverageData = JSON.parse(coverage);
          } catch (e) {}
          
          const coveragePercent = coverageData.result?.line || 'N/A';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## Test Results âœ…\n\n**Coverage:** ${coveragePercent}%\n\nAll tests passed!`
          });

  security:
    name: Security Checks
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ env.RUBY_VERSION }}
        bundler-cache: true
    
    - name: Run Brakeman Security Scan
      run: |
        bundle exec brakeman -f json -o tmp/brakeman.json
        bundle exec brakeman -f text
    
    - name: Upload Brakeman Results
      uses: actions/upload-artifact@v5
      if: always()
      with:
        name: brakeman-results
        path: tmp/brakeman.json
    
    - name: Run Bundle Audit
      run: bundle exec bundle-audit check --update

  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ env.RUBY_VERSION }}
        bundler-cache: true
    
    - name: Run RuboCop
      run: bundle exec rubocop --format github
    
    - name: Check for TODOs
      run: |
        if grep -r "TODO\|FIXME\|HACK" --include="*.rb" --include="*.js" --include="*.css" .; then
          echo "::warning::Found TODO/FIXME/HACK comments in code"
        fi

  visual-regression:
    name: Visual Regression Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ env.RUBY_VERSION }}
        bundler-cache: true
    
    - name: Install Chrome
      uses: browser-actions/setup-chrome@v1
    
    - name: Run Visual Tests
      run: |
        mkdir -p tmp/screenshots
        bundle exec rspec spec/visual --format documentation
    
    - name: Upload Screenshots
      uses: actions/upload-artifact@v5
      if: always()
      with:
        name: screenshots
        path: tmp/screenshots/

  dependency-check:
    name: Dependency Security Check
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Run Dependabot Security Scan
      uses: dependabot/fetch-metadata@v2
      continue-on-error: true
    
    - name: Check for Outdated Dependencies
      run: |
        bundle outdated --strict || true
        echo "::warning::Some dependencies are outdated"