# CoStar Kamal Deployment Configuration
service: costar

# Docker image (GitHub Container Registry - free private images)
image: jabawack81/costar

# SSH configuration (matches host alias in ~/.ssh/config)
ssh:
  user: deploy
  port: 1447

# Server configuration
servers:
  web:
    hosts:
      - digitalocean-vps-deploy
    labels:
      # Traefik routing for HTTP/HTTPS
      traefik.enable: true
      traefik.http.routers.costar-web.rule: Host(`costar.internetblacksmith.dev`)
      traefik.http.routers.costar-web.entrypoints: websecure
      traefik.http.routers.costar-web.tls.certresolver: letsencrypt
      traefik.http.services.costar-web.loadbalancer.server.port: 4567
      # Rate limiting (brute-force protection)
      traefik.http.routers.costar-web.middlewares: costar-ratelimit
      traefik.http.middlewares.costar-ratelimit.ratelimit.average: 20
      traefik.http.middlewares.costar-ratelimit.ratelimit.burst: 50
      traefik.http.middlewares.costar-ratelimit.ratelimit.period: 1s
      # HTTP to HTTPS redirect
      traefik.http.routers.costar-web-http.rule: Host(`costar.internetblacksmith.dev`)
      traefik.http.routers.costar-web-http.entrypoints: web
      traefik.http.routers.costar-web-http.middlewares: costar-redirect-https
      traefik.http.middlewares.costar-redirect-https.redirectscheme.scheme: https
      traefik.http.middlewares.costar-redirect-https.redirectscheme.permanent: true
    cmd: bundle exec puma -C config/puma.rb
    options:
      network: "private"
    proxy: false

# Docker registry authentication (GitHub Container Registry)
registry:
  server: ghcr.io
  username: jabawack81
  password:
    - KAMAL_REGISTRY_PASSWORD

# Builder configuration
builder:
  arch: amd64

# Environment variables
# Note: Secrets are injected during deployment via Doppler on local machine,
# not fetched at runtime. These are passed to the container at runtime.
env:
  clear:
    RACK_ENV: production
  secret:
    - TMDB_API_KEY
    - REDIS_URL
    - SENTRY_DSN
    - SENTRY_ENVIRONMENT
    - SESSION_SECRET
    - POSTHOG_API_KEY

# Redis accessory for caching
accessories:
  redis:
    image: redis:7.4-alpine
    host: digitalocean-vps-deploy
    directories:
      - data:/data
    cmd: redis-server --save 60 1 --loglevel warning
    options:
      network: "private"

# Persistent volumes for application data
volumes:
  - costar-data:/app/data
