#!/usr/bin/env ruby
# frozen_string_literal: true

# Development server with file watching (replaces rerun)
require 'filewatcher'

WATCHED_PATTERNS = %w[
  **/*.rb
  **/*.erb
  **/*.css
  **/*.js
  **/*.yml
  **/*.yaml
  config.ru
  Gemfile
  Gemfile.lock
].freeze

def start_server
  puts "ğŸš€ Starting Sinatra server..."
  pid = spawn("ruby app.rb")
  Process.detach(pid)
  pid
end

def stop_server(pid)
  return unless pid
  
  begin
    Process.kill("TERM", pid)
    sleep(1)
    Process.kill("KILL", pid) if process_running?(pid)
  rescue Errno::ESRCH
    # Process already dead
  end
end

def process_running?(pid)
  Process.kill(0, pid)
  true
rescue Errno::ESRCH
  false
end

# Change to project root
project_root = File.expand_path('..', __dir__)
Dir.chdir(project_root)

puts "ğŸ¬ ActorSync Development Server with File Watching"
puts "=" * 50
puts "ğŸ“ Project root: #{project_root}"
puts "ğŸ‘ï¸  Watching: #{WATCHED_PATTERNS.join(', ')}"
puts "ğŸ”„ Server will restart when files change"
puts "â¹ï¸  Press Ctrl+C to stop"
puts "=" * 50

server_pid = start_server

# Handle graceful shutdown
trap("INT") do
  puts "\nâ¹ï¸  Shutting down server..."
  stop_server(server_pid)
  puts "âœ… Server stopped"
  exit(0)
end

trap("TERM") do
  stop_server(server_pid)
  exit(0)
end

# Watch for file changes
Filewatcher.new(WATCHED_PATTERNS, immediate: false).watch do |changes|
  puts "\nğŸ”„ File changes detected:"
  changes.each do |filename, event|
    puts "   #{event}: #{filename}"
  end
  
  puts "ğŸ”„ Restarting server..."
  stop_server(server_pid)
  sleep(0.5)  # Brief pause before restart
  server_pid = start_server
  puts "âœ… Server restarted"
end