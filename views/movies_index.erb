<main>
    <section class="intro-section">
        <div class="intro-content">
            <p class="intro-text">
                <span style="color: var(--magenta); text-shadow: 0 0 3px #ff00aa44;">&gt;</span> Search for two movies and discover all the actors who appeared in both.
            </p>
        </div>
    </section>

    <section class="search-section">
        <div class="mdc-card search-card">
            <div class="panel-header">
                Query Interface
                <span class="header-line"></span>
            </div>

            <div class="search-form">
                <div class="field-container" id="movie1-container">
                    <div class="mdc-text-field mdc-text-field--filled mdc-text-field--with-trailing-icon">
                        <span class="mdc-text-field__ripple"></span>
                        <span class="mdc-floating-label" id="movie1-label">First Movie</span>
                        <input type="text" 
                               class="mdc-text-field__input" 
                               id="movie1"
                               name="q"
                               hx-get="/api/movies/search" 
                               hx-trigger="keyup changed delay:300ms"
                               hx-target="#movie-suggestions1"
                               hx-include="this"
                               hx-vals='{"field": "movie1"}'
                               autocomplete="off"
                               aria-label="Search for first movie">
                        <span class="mdc-line-ripple"></span>
                    </div>
                    <input type="hidden" id="movie1_id" name="movie1_id">
                    <input type="hidden" id="movie1_title" name="movie1_title">
                    <div class="suggestions" id="movie-suggestions1"></div>
                </div>
                
                <div class="field-container" id="movie2-container">
                    <div class="mdc-text-field mdc-text-field--filled mdc-text-field--with-trailing-icon">
                        <span class="mdc-text-field__ripple"></span>
                        <span class="mdc-floating-label" id="movie2-label">Second Movie</span>
                        <input type="text" 
                               class="mdc-text-field__input" 
                               id="movie2"
                               name="q"
                               hx-get="/api/movies/search" 
                               hx-trigger="keyup changed delay:300ms"
                               hx-target="#movie-suggestions2"
                               hx-include="this"
                               hx-vals='{"field": "movie2"}'
                               autocomplete="off"
                               aria-label="Search for second movie">
                        <span class="mdc-line-ripple"></span>
                    </div>
                    <input type="hidden" id="movie2_id" name="movie2_id">
                    <input type="hidden" id="movie2_title" name="movie2_title">
                    <div class="suggestions" id="movie-suggestions2"></div>
                </div>
                
                <!-- Keep hidden fields outside containers to ensure they persist -->
                <input type="hidden" id="movie1_id_backup" name="movie1_id_backup">
                <input type="hidden" id="movie2_id_backup" name="movie2_id_backup">
                <input type="hidden" id="movie1_title_backup" name="movie1_title_backup">
                <input type="hidden" id="movie2_title_backup" name="movie2_title_backup">
            </div>
            
            <div class="compare-button-container">
                <button class="mdc-button mdc-button--raised" 
                        id="compareMoviesBtn"
                        data-mdc-auto-init="MDCRipple"
                        hx-get="/api/movies/compare"
                        hx-target="#movie-results"
                        hx-cache="false"
                        hx-vals='js:{
                            "movie1_id": document.getElementById("movie1_id_backup").value, 
                            "movie2_id": document.getElementById("movie2_id_backup").value, 
                            "movie1_title": document.getElementById("movie1_title_backup").value, 
                            "movie2_title": document.getElementById("movie2_title_backup").value
                        }'
                        hx-indicator="#movie-results"
                        onclick="trackMovieComparison();">
                    <span class="mdc-button__ripple"></span>
                    <span class="mdc-button__label">Find Common Actors</span>
                </button>
            </div>
        </div>
    </section>

    <section class="results-section" id="results">
        <div class="mdc-card results-card">
            <div class="results-label">
                Output Stream
                <span class="header-line"></span>
            </div>
            <div class="movie-results-container" id="movie-results">
                <!-- Movie comparison results will be inserted here -->
            </div>
        </div>
    </section>
    
    <!-- MDC FAB for scroll to top -->
    <button class="mdc-fab mdc-fab--mini" id="scrollToTop" data-mdc-auto-init="MDCRipple">
        <div class="mdc-fab__ripple"></div>
        <span class="mdc-fab__icon material-icons">keyboard_arrow_up</span>
    </button>
    
    <!-- MDC Snackbar for notifications -->
    <div class="mdc-snackbar" id="snackbar" data-mdc-auto-init="MDCSnackbar">
        <div class="mdc-snackbar__surface" role="status" aria-relevant="additions">
            <div class="mdc-snackbar__label" id="snackbarMessage" aria-atomic="false"></div>
            <div class="mdc-snackbar__actions" aria-atomic="true">
                <button type="button" class="mdc-button mdc-snackbar__action" id="snackbarAction" data-mdc-auto-init="MDCRipple">
                    <div class="mdc-button__ripple"></div>
                    <span class="mdc-button__label">UNDO</span>
                </button>
            </div>
        </div>
    </div>
</main>

<script>
// Movie search functionality
(function() {
    window.selectMovie = function(id, title, field) {
        // Set hidden fields
        document.getElementById(field + '_id').value = id;
        document.getElementById(field + '_title').value = title;
        document.getElementById(field + '_id_backup').value = id;
        document.getElementById(field + '_title_backup').value = title;
        
        // Get the container and input
        const container = document.getElementById(field + '-container');
        const input = document.getElementById(field);
        const suggestions = document.getElementById('movie-suggestions' + field.replace('movie', ''));
        
        // Clear suggestions
        suggestions.innerHTML = '';
        
        // Replace input with chip
        const chip = document.createElement('div');
        chip.className = 'selected-chip';
        chip.innerHTML = `
            <span class="chip-text">${title}</span>
            <button type="button" class="chip-remove" onclick="removeMovie('${field}')" aria-label="Remove ${title}">
                <span class="material-icons">close</span>
            </button>
        `;
        
        // Hide input, show chip
        input.style.display = 'none';
        input.parentNode.insertBefore(chip, input);
    };
    
    window.removeMovie = function(field) {
        // Clear hidden fields
        document.getElementById(field + '_id').value = '';
        document.getElementById(field + '_title').value = '';
        document.getElementById(field + '_id_backup').value = '';
        document.getElementById(field + '_title_backup').value = '';
        
        // Get the container and input
        const container = document.getElementById(field + '-container');
        const input = document.getElementById(field);
        const chip = container.querySelector('.selected-chip');
        
        // Remove chip, show input
        if (chip) chip.remove();
        input.style.display = '';
        input.value = '';
        input.focus();
    };
    
    window.trackMovieComparison = function() {
        if (typeof posthog !== 'undefined') {
            posthog.capture('movie_comparison_clicked', {
                movie1_id: document.getElementById('movie1_id_backup').value,
                movie2_id: document.getElementById('movie2_id_backup').value
            });
        }
    };
})();
</script>

<% if @movie1_id && @movie2_id %>
<script>
// Pre-populate backup fields immediately
document.getElementById('movie1_id_backup').value = '<%= @movie1_id %>';
document.getElementById('movie2_id_backup').value = '<%= @movie2_id %>';
<% if @movie1_title %>
document.getElementById('movie1_title_backup').value = '<%= @movie1_title.gsub("'", "\\'") %>';
<% end %>
<% if @movie2_title %>
document.getElementById('movie2_title_backup').value = '<%= @movie2_title.gsub("'", "\\'") %>';
<% end %>

// Auto-trigger comparison when movie IDs are provided
document.addEventListener('DOMContentLoaded', function() {
    // Show pills for selected movies
    <% if @movie1_title && @movie1_id %>
    window.selectMovie('<%= @movie1_id %>', '<%= @movie1_title.gsub("'", "\\'") %>', 'movie1');
    <% end %>
    
    <% if @movie2_title && @movie2_id %>
    window.selectMovie('<%= @movie2_id %>', '<%= @movie2_title.gsub("'", "\\'") %>', 'movie2');
    <% end %>
    
    // Trigger comparison immediately
    requestAnimationFrame(function() {
        const compareBtn = document.getElementById('compareMoviesBtn');
        if (compareBtn) {
            compareBtn.click();
        }
    });
});
</script>
<% end %>
