<div class="timeline">
    <!-- Actor Portrait Header -->
    <div class="actor-portrait-header" style="display: flex !important; flex-direction: row !important; align-items: flex-start !important;">
        <div class="actor-portrait-left" style="flex: 0 0 25% !important; display: flex !important; justify-content: center !important; align-items: flex-start !important;">
            <%= erb :'partials/_actor_portrait', locals: { 
                actor_name: @actor1_name, 
                actor_profile: @actor1_profile 
            } %>
        </div>
        <div class="actor-portrait-center" style="flex: 1 !important; display: flex !important; justify-content: center !important; align-items: center !important; gap: 12px !important;">
            <!-- View Toggle Slider -->
            <div class="toggle-slider-container">
                <span class="toggle-slider-label toggle-slider-label--left">Shared</span>
                <label class="toggle-slider">
                    <input type="checkbox" id="movies-toggle" onchange="toggleView()">
                    <span class="toggle-slider-track">
                        <span class="toggle-slider-thumb"></span>
                    </span>
                </label>
                <span class="toggle-slider-label toggle-slider-label--right">All</span>
            </div>
            
            <!-- Share Button -->
            <button class="btn btn--primary share-button" onclick="shareTimeline()">
                <span class="material-icons btn__icon">share</span>
                <span class="btn__label">Share Timeline</span>
            </button>
        </div>
        <div class="actor-portrait-right" style="flex: 0 0 25% !important; display: flex !important; justify-content: center !important; align-items: flex-start !important;">
            <%= erb :'partials/_actor_portrait', locals: { 
                actor_name: @actor2_name, 
                actor_profile: @actor2_profile 
            } %>
        </div>
    </div>
    
    <!-- Timeline content wrapper -->
    <div class="timeline-content">
        <!-- Mobile timeline lines -->
        <div class="mobile-timeline-left"></div>
        <div class="mobile-timeline-right"></div>
    
    <% @years.each do |year| %>
        <% next unless @processed_movies[year] %>
        
        <% shared_movies_this_year = @shared_movies_by_year[year] || [] %>
        
        <div class="year-group" data-year="<%= year %>"<%= shared_movies_this_year.empty? ? ' style="display: none;"' : '' %>>
            <%= erb :'partials/_year_header', locals: { 
                year: year, 
                shared_movies_count: shared_movies_this_year.length 
            } %>
            
            <div class="movies-timeline">
                <% @processed_movies[year].each do |entry| %>
                    <% if entry[:type] == :shared %>
                        <!-- Shared movie on same line -->
                        <div class="movie-row shared-movie-row">
                            <div class="movie-left">
                                <% left_movie = entry[:movies].find { |m| m[:side] == :left } %>
                                <% if left_movie %>
                                    <% mobile_actors_info = [
                                        "#{left_movie[:actor]}: #{left_movie[:movie][:character] || 'Unknown'}",
                                        "#{entry[:movies].find { |m| m[:side] == :right }&.dig(:actor) || ''}: #{entry[:movies].find { |m| m[:side] == :right }&.dig(:movie, :character) || 'Unknown'}"
                                    ].compact %>
                                    
                                    <%= erb :'partials/_movie_card', locals: { 
                                        movie: left_movie[:movie], 
                                        actor_name: left_movie[:actor], 
                                        shared: true,
                                        mobile_actors_info: mobile_actors_info
                                    } %>
                                <% else %>
                                    <div class="movie-placeholder"></div>
                                <% end %>
                            </div>
                            
                            <div class="movie-center">
                                <div class="shared-movie-indicator">
                                    <span class="material-icons">movie</span>
                                </div>
                            </div>
                            
                            <div class="movie-right">
                                <% right_movie = entry[:movies].find { |m| m[:side] == :right } %>
                                <% if right_movie %>
                                    <div class="desktop-only">
                                        <%= erb :'partials/_movie_card', locals: { 
                                            movie: right_movie[:movie], 
                                            actor_name: right_movie[:actor], 
                                            shared: true,
                                            mobile_actors_info: nil
                                        } %>
                                    </div>
                                <% else %>
                                    <div class="movie-placeholder"></div>
                                <% end %>
                            </div>
                        </div>
                    <% else %>
                        <!-- Single movie on its own line -->
                        <div class="movie-row single-movie-row individual-movie" style="display: none;">
                            <% if entry[:movie][:side] == :left %>
                                <div class="movie-left">
                                    <%= erb :'partials/_movie_card', locals: { 
                                        movie: entry[:movie][:movie], 
                                        actor_name: entry[:movie][:actor], 
                                        shared: false,
                                        mobile_actors_info: nil
                                    } %>
                                </div>
                                <div class="movie-center"></div>
                                <div class="movie-right">
                                    <div class="movie-placeholder"></div>
                                </div>
                            <% else %>
                                <div class="movie-left">
                                    <div class="movie-placeholder"></div>
                                </div>
                                <div class="movie-center"></div>
                                <div class="movie-right">
                                    <%= erb :'partials/_movie_card', locals: { 
                                        movie: entry[:movie][:movie], 
                                        actor_name: entry[:movie][:actor], 
                                        shared: false,
                                        mobile_actors_info: nil
                                    } %>
                                </div>
                            <% end %>
                        </div>
                    <% end %>
                <% end %>
            </div>
        </div>
    <% end %>
    </div> <!-- End timeline-content -->
</div>

<script>
// View toggle state - use window scope to persist across HTMX replacements
if (typeof window.showingFullFilmographies === 'undefined') {
    window.showingFullFilmographies = false;
}

function toggleView() {
    const individualMovies = document.querySelectorAll('.individual-movie');
    const yearGroups = document.querySelectorAll('.year-group');
    const toggle = document.getElementById('movies-toggle');

    window.showingFullFilmographies = toggle.checked;

    if (window.showingFullFilmographies) {
        // Show full filmographies
        individualMovies.forEach(movie => {
            movie.style.display = 'flex';
        });
        yearGroups.forEach(yearGroup => {
            yearGroup.style.display = 'block';
        });
    } else {
        // Show only shared movies
        individualMovies.forEach(movie => {
            movie.style.display = 'none';
        });

        // Hide year groups that have no shared movies
        yearGroups.forEach(yearGroup => {
            const hasSharedMovies = yearGroup.querySelector('.shared-movie-row');
            if (!hasSharedMovies) {
                yearGroup.style.display = 'none';
            } else {
                yearGroup.style.display = 'block';
            }
        });
    }
}

function shareTimeline() {
    // Get actor IDs from template variables
    const actor1Id = '<%= @actor1_id %>';
    const actor2Id = '<%= @actor2_id %>';
    
    // Build the shareable URL
    const shareUrl = `${window.location.origin}/?actor1_id=${actor1Id}&actor2_id=${actor2Id}`;
    
    // Copy to clipboard
    navigator.clipboard.writeText(shareUrl).then(() => {
        // Show success message using custom toast
        const snackbar = document.createElement('div');
        snackbar.className = 'toast toast--open';
        snackbar.innerHTML = `
            <div class="toast__surface">
                <div class="toast__label">Timeline link copied to clipboard!</div>
            </div>
        `;
        document.body.appendChild(snackbar);
        
        // Remove snackbar after 3 seconds
        setTimeout(() => {
            snackbar.remove();
        }, 3000);
    }).catch(err => {
        // Fallback for older browsers
        const tempInput = document.createElement('input');
        tempInput.value = shareUrl;
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand('copy');
        document.body.removeChild(tempInput);
        
        // Show success message
        alert('Timeline link copied to clipboard!');
    });
}

// Detect when header becomes sticky and add shrink effect
// Only initialize once to avoid duplicate event listeners when HTMX replaces content
if (typeof window._timelineScrollHandlerInitialized === 'undefined') {
    window._timelineScrollHandlerInitialized = true;
    
    window.addEventListener('load', function() {
        const header = document.querySelector('.actor-portrait-header');
        if (!header) return;
        
        let isStuck = false;
        
        // Simple scroll handler - shrink after scrolling 50px
        function handleScroll() {
            const scrolled = window.pageYOffset || document.documentElement.scrollTop;
            const shouldBeStuck = scrolled > 50;
            
            // Only modify classes if state actually changes
            if (shouldBeStuck && !isStuck) {
                header.classList.add('stuck');
                isStuck = true;
            } else if (!shouldBeStuck && isStuck) {
                header.classList.remove('stuck');
                isStuck = false;
            }
        }
        
        // Throttle scroll events for better performance
        let scrollTimeout;
        function throttledScroll() {
            if (!scrollTimeout) {
                scrollTimeout = setTimeout(function() {
                    handleScroll();
                    scrollTimeout = null;
                }, 10); // Run at most every 10ms
            }
        }
        
        // Listen for scroll events
        window.addEventListener('scroll', throttledScroll);
        
        // Check initial state
        handleScroll();
    });
}
</script>