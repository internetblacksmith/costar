<div class="timeline">
    <% @years.each do |year| %>
        <% actor1_movies = @actor1_movies.select { |m| m[:year] == year } %>
        <% actor2_movies = @actor2_movies.select { |m| m[:year] == year } %>
        <% next if actor1_movies.empty? && actor2_movies.empty? %>
        
        <% shared_movies_this_year = @shared_movies.select { |m| m[:year] == year } %>
        
        <div class="year-group">
            <div class="year-header">
                <% if shared_movies_this_year.any? %>
                    <div class="shared-indicator">
                        <span class="material-icons">movie</span>
                        <span>Shared Movies! (<%= shared_movies_this_year.length %>)</span>
                    </div>
                <% end %>
                <div class="year-text">
                    <%= year %>
                </div>
            </div>
            
            <div class="movies-timeline">
                <% 
                # Create a unified list of all movies for this year with their release dates
                all_movies_this_year = []
                
                # Add actor1 movies
                actor1_movies.each do |movie|
                    all_movies_this_year << {
                        movie: movie,
                        actor: @actor1_name,
                        side: :left,
                        is_shared: @shared_movies.any? { |shared| shared[:id] == movie[:id] }
                    }
                end
                
                # Add actor2 movies
                actor2_movies.each do |movie|
                    all_movies_this_year << {
                        movie: movie,
                        actor: @actor2_name,
                        side: :right,
                        is_shared: @shared_movies.any? { |shared| shared[:id] == movie[:id] }
                    }
                end
                
                # Sort by release date
                all_movies_this_year.sort_by! { |item| item[:movie][:release_date] || "0000-00-00" }
                
                # Group shared movies together
                processed_movies = []
                shared_movie_ids = []
                
                all_movies_this_year.each do |item|
                    if item[:is_shared] && !shared_movie_ids.include?(item[:movie][:id])
                        # Find both versions of this shared movie
                        shared_versions = all_movies_this_year.select { |m| m[:movie][:id] == item[:movie][:id] }
                        processed_movies << { type: :shared, movies: shared_versions }
                        shared_movie_ids << item[:movie][:id]
                    elsif !item[:is_shared]
                        processed_movies << { type: :single, movie: item }
                    end
                end
                %>
                
                <% processed_movies.each do |entry| %>
                    <% if entry[:type] == :shared %>
                        <!-- Shared movie on same line -->
                        <div class="movie-row shared-movie-row">
                            <div class="movie-left">
                                <% left_movie = entry[:movies].find { |m| m[:side] == :left } %>
                                <% if left_movie %>
                                    <div class="movie-item shared">
                                        <div class="mdc-card movie-card">
                                            <div class="movie-title">
                                                <%= left_movie[:movie][:title] %>
                                                <span class="material-icons" style="color: var(--movie-shared-text); font-size: 16px; vertical-align: middle;">star</span>
                                            </div>
                                            <div class="movie-character">as <%= left_movie[:movie][:character] || 'Unknown' %></div>
                                            <div class="movie-actor"><%= left_movie[:actor] %></div>
                                            <% right_movie = entry[:movies].find { |m| m[:side] == :right } %>
                                            <% if right_movie %>
                                                <div class="mobile-shared-actors">
                                                    <div class="mobile-actor-detail"><%= left_movie[:actor] %>: <%= left_movie[:movie][:character] || 'Unknown' %></div>
                                                    <div class="mobile-actor-detail"><%= right_movie[:actor] %>: <%= right_movie[:movie][:character] || 'Unknown' %></div>
                                                </div>
                                            <% end %>
                                        </div>
                                    </div>
                                <% else %>
                                    <div class="movie-placeholder"></div>
                                <% end %>
                            </div>
                            
                            <div class="movie-center">
                                <div class="shared-movie-indicator">
                                    <span class="material-icons">movie</span>
                                </div>
                            </div>
                            
                            <div class="movie-right">
                                <% right_movie = entry[:movies].find { |m| m[:side] == :right } %>
                                <% if right_movie %>
                                    <div class="movie-item shared">
                                        <div class="mdc-card movie-card">
                                            <div class="movie-title">
                                                <%= right_movie[:movie][:title] %>
                                                <span class="material-icons" style="color: var(--movie-shared-text); font-size: 16px; vertical-align: middle;">star</span>
                                            </div>
                                            <div class="movie-character">as <%= right_movie[:movie][:character] || 'Unknown' %></div>
                                            <div class="movie-actor"><%= right_movie[:actor] %></div>
                                        </div>
                                    </div>
                                <% else %>
                                    <div class="movie-placeholder"></div>
                                <% end %>
                            </div>
                        </div>
                    <% else %>
                        <!-- Single movie on its own line -->
                        <div class="movie-row single-movie-row">
                            <% if entry[:movie][:side] == :left %>
                                <div class="movie-left">
                                    <div class="movie-item">
                                        <div class="mdc-card movie-card">
                                            <div class="movie-title"><%= entry[:movie][:movie][:title] %></div>
                                            <div class="movie-character">as <%= entry[:movie][:movie][:character] || 'Unknown' %></div>
                                            <div class="movie-actor"><%= entry[:movie][:actor] %></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="movie-center"></div>
                                <div class="movie-right">
                                    <div class="movie-placeholder"></div>
                                </div>
                            <% else %>
                                <div class="movie-left">
                                    <div class="movie-placeholder"></div>
                                </div>
                                <div class="movie-center"></div>
                                <div class="movie-right">
                                    <div class="movie-item">
                                        <div class="mdc-card movie-card">
                                            <div class="movie-title"><%= entry[:movie][:movie][:title] %></div>
                                            <div class="movie-character">as <%= entry[:movie][:movie][:character] || 'Unknown' %></div>
                                            <div class="movie-actor"><%= entry[:movie][:actor] %></div>
                                        </div>
                                    </div>
                                </div>
                            <% end %>
                        </div>
                    <% end %>
                <% end %>
            </div>
        </div>
    <% end %>
</div>